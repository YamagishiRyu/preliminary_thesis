\documentclass[a4j,10pt, twocolumn]{jarticle}
\usepackage[dvipdfmx]{graphicx}
\usepackage[top=3cm, bottom=27mm, left=18mm, right=18mm]{geometry}
\usepackage{bm}
\usepackage[psamsfonts]{amssymb}
\usepackage{amsmath}
\usepackage{float}
\usepackage{tikz}
\usetikzlibrary{bayesnet}
\usepackage{algorithm}
\usepackage{algorithmicx}
\usepackage{algpseudocode}
\usepackage{titlesec}
\usepackage{comment}
\usepackage{caption}
%---------------------------------------------------
% ページの設定
%---------------------------------------------------
\pagestyle{empty}
\fontsize{10.5pt}{0pt}\selectfont
\titleformat*{\section}{\normalsize\bfseries}
\titleformat*{\subsection}{\normalsize\bfseries}
\titleformat*{\subsubsection}{\normalsize\bfseries}

\begin{document}
\twocolumn
[
\begin{center}
{\large ユーザー体験に基づく個人化観光推薦システム} \\
{\large Personalized Sightseeing Recommendation System Based on User Experience} \\
山岸 立 \\
Ryu Yamagishi

\vspace{2truemm}
  \setlength{\leftskip}{.7cm}
  \setlength{\rightskip}{.7cm}
  {\setlength{\oddsidemargin}{50mm}
  現在の観光推薦システムは特定の場所に集中し，個人の好みに合うものではない．
  そこで本論文では，FlickrやInstagramなどの投稿を対象にユーザの嗜好を分析する確率モデルとそれに基づくユーザの求める観光体験を推薦するシステムを提案する．
  提案する推薦システムでは，ユーザ体験の4要素(Who, When, Where, What)をモデリングし，ユーザの行動データに応じて逐次的にユーザの嗜好を推論しながら観光スポットや観光体験を推薦する．
}

\end{center}
\vspace{2truemm}
]


%---------------------------------------------------
% 本文
%---------------------------------------------------
\section{はじめに} \label{introduction}
観光において，多くの人は観光する都市が決まったら旅行雑誌や観光ウェブサイトを見て調べ，行く場所を決定することが多い．
そのような雑誌やウェブサイトは多くの情報を含んでおり，ときにどれを選べば良いのかわからなくなることがある．
自分たちが知らない土地で書いてある説明だけをみて自分たちが本当に行きたい場所をみつことは容易ではない．
また，これらの媒体は過度に有名な観光地に偏っている．
それは誰が調べても同じ結果を示すため，より人気の高い場所を示すことが圧倒的に多いからである．
このことは観光地におけるオーバーツーリズムを誘発し，観光地にも観光客にも負の影響をもたらす．
それゆえそれらの観光の問題を解決するためには個人化を実現した観光推薦システムが必要となる．
個人化をすることで，観光客は本当に自分の好みにあった場所に行くことができ，同時に観光客を色々な場所に分散させることが可能となる．

例として京都に観光に行くことを挙げる．
Googleで"京都 観光"と検索すると有名な観光地のリストがその地図上の場所とともに表示される
これは誰が検索しても同じ結果を示し，個々人のユーザに特化した検索結果ではない．
京都にすでに住んでいる地元の人も日本に初めて来る外国人も同じ結果が示される．
また，食べ歩きが好きな人も寺社をじっくり見たい人も同じ結果が示される．
そしてそれは清水寺や金閣寺，伏見稲荷大社などの有名すぎて過度に人が集まっている場所である．
この状況ではユーザにとっても自分が求めた答えかわからず，観光地もオーバーツーリズムが加速するばかりであり，早急な個人化が必要となる．

また，本研究では観光はある場所に行くだけでなく，その場で何をするのかを含めて観光と考えている．
それゆえそのような体験を推薦システムでも提供すべきであると考える．
本研究では\cite{yuan2013and}で示されている通り，観光体験とは4つの要素からなるとする．
4つの要素は行動の主体を表すWho,時間を表すWhen,場所を表すWhere, そして行動自体をあらわすWhatである．
この4要素を考慮することで，誰がいつどこで何をしたかという体験の具体的な部分を表すことができる．

そして，昨今InstagramやFlickrに代表されるような写真を主体としたSNSが流行している．
このような写真を主体とした投稿データは観光体験を表すデータに最適である．
写真によって何を行ったのかというWhatの部分が明確であり，その投稿に付随して場所，時間を取得できる．
それゆえ，本研究におけるデータセットとして最適である．

本研究では，この4つの要素をトピックモデルを用いて分析することでその人の趣味嗜好および場所の特性を考慮して，推薦システムで複数の体験を推薦する手法を提案する．

本論文における貢献は以下である．
\begin{quote}
  \begin{itemize}
    \item InstagramやFlickrに公開されている画像とそのメタデータを用いて，ユーザの体験を分析する確率モデルを提案する．
    \item ユーザを複数グループに分割し，そのグループごとにその人々の趣味嗜好との関係を確率的に分析する．これにより個々の観光客のデータが少ない，いわゆるコールドスタート問題を緩和する．
    \item 観光における推薦システムでありながら，場所だけでなくその場における行動まで推薦することができる．
  \end{itemize}
\end{quote}

以下では，\ref{related_work}節で関連した研究を紹介し，\ref{proposed_method}節で提案手法を示す．
そして提案手法に関する実験を説明した後に提案手法を応用したアプリケーションを\ref{application}節で説明する．
最後に\ref{future_work}, \ref{summary}節で今後の課題とまとめについて述べる．

%---------------------------------------------------
\section{関連研究} \label{related_work}
Q.YuanらはTwitterを対象にユーザの行動を分析するモデルを提案している\cite{yuan2013and}\cite{yuan2015and}．
この研究ではユーザの行動をWho, Where, When, Whatで分割し，Twitterのデータを利用して行動分析および予測を行っている．
Yuanらの手法は，日常生活でたくさん発信される位置情報付きの情報を対象としているが，個人個人のデータ量が少ない観光では適用困難である．
そのため，我々のモデルでは似た行動をするユーザをグループ化し，それを表現する潜在変数をモデルに導入している．

普段の生活圏では決まった行動を取りやすいが，観光においては全く異なる行動指針によって動く．
実際に\cite{song2010limits}では普段の行動の軌跡の情報量を測ることで最大93\%の精度で行動予測できることを述べている．
また，同時に旅行時の行動は大きな違いがあることも述べている．
故に同じPoint of Interest(POI)の分野でもその普段の行動であるかどうかを見ることが重要となる．
特に\cite{liu2017experimental}では，POIの分野で普段の行動かどうか，つまりin townかout of townかによって多くの研究が整理され，まとめられている．

観光の行動予測で最も問題となるのが，同じユーザでの再現性の少なさである．
観光においては同じ場所に何回も行くことが少ない．
旅行できて，特定の観光地を転々と観光し，その後は一度も来ないということは少なくない．
つまり，ユーザと場所の関係はスパースなものとなりやすく，データの扱いに注意が必要となる．
\cite{ference2013location}\cite{yin2013lcars}\cite{wang2015geo}\cite{yin2016joint}ではそのような問題に取り組み, in townとout of townどちらにも対応できるようなモデルを作っている．
特に\cite{ference2013location}は確率モデルでの分析をするものではなく，協調フィルタリングベースで推薦システムを構成している．

\cite{wang2015geo}\cite{zhuang2017sns}\cite{馬強2017観光情報学の最前線}\cite{馬強2019観光の分散化と個人化の実現に向けたユーザ生成コンテンツの分析と利活用技術について}では，データがスパースになる問題に加え，コールドスタート問題に陥ってしまうことに対してグループという概念を入れることによって対応している．
グループを入れることで，一人のユーザのデータが少なくてもグループ全体で特徴が捉えられていれば，最適な推薦をすることができる．
これに習って，本研究もユーザをグループに分割し，グループごとに趣味嗜好を捉える．

%---------------------------------------------------
\section{提案手法} \label{proposed_method}
この節では観光体験の分析と推薦手法について説明する．
分析手法ではユーザの行動データからユーザごとの趣味嗜好を捉える．
推薦手法では分析手法で捉えたユーザの趣味嗜好を用い，新しいユーザに対して適用してその人にあった観光体験を推薦する．

\subsection{問題提起} \label{def}
この節では解決すべき問題を明確にする．
本研究で提案する推薦システムはユーザ体験の過去の履歴データからユーザの趣味嗜好を抽出し，ユーザ体験を提供するものである．
ここでのユーザ体験とは, 節\ref{introduction}で述べた通り次の4つで構成される．
\begin{description}
  \setlength{\leftskip}{.5cm}
  \item[\textbf{Who}] 誰が行ったのか
  \item[\textbf{When}] いつ行ったのか
  \item[\textbf{Where}] どこで行ったのか
  \item[\textbf{What}] 何を行ったのか
\end{description}
ゆえに本研究の推薦システムはデータセットからこの4要素を読み出し，ユーザの趣味嗜好を踏まえてこの4要素を推薦する．

データセットはこの4要素を含むものでなくてはならない．
そこで先述したFlickrやInstagramのような写真を主体とした投稿データは最適である．
というのも，そのような投稿データには写真と投稿に付随した文章，タグからWhatの要素を検出でき，メタデータとして位置情報と時間が含まれているからである．
ここでいう時間は写真を投稿した時間ではなく写真を撮った時間すなわち行動を行ったその時刻をさす．
ただし，旅行先の時差や投稿時間しかない場合は時間単位でデータを捉えるのではなく，昼夜などの大きい枠でデータを捉えることとする．
以上の理由で本研究もこのような写真を主体としたSNSの投稿データをデータセットとしてみなす．

また，観光における行動データの性質としてデータのスパース性が挙げられる．
そのため本研究ではユーザの趣味嗜好に基づいたグループを導入する．
似ている趣味嗜好のユーザが同じグループに属するようにする．
その結果一人あたりのデータが少なくてもよりその人の趣味嗜好に合いそうなものを推薦することが可能になる．


\subsection{観察} \label{intuition}
分析手法では，ユーザがどのような場所，どのような行動を好むのかをモデリングして，過去の履歴データから発見する．
本研究では，以下のような観測に基づいて観光地におけるユーザの行動が決定されると考える．

\begin{description}
  \setlength{\leftskip}{.5cm}
  \item[\textbf{観察1}] 趣味嗜好が似ている人は複数人いる．つまり，趣味嗜好(以降トピック)を基準にユーザをいくつかのグループに分割できる．逆にグループは複数のユーザを持ち，特定のトピックを持つことになる．例えば，あるユーザAとあるユーザBの趣味嗜好が似ている場合，AとBは同じグループに属し，Aがある場所である行動を好むのならばそれがBにも当てはまる可能性が高い．
  \item[\textbf{観察2}] 訪れる場所はユーザの趣味嗜好によって決定される．趣味嗜好が似ているならば同じ場所に行く確率は高い．例えば有名場所が好きな人たちは京都でいう金閣寺や伏見稲荷大社に行くことを好むが，甘味が好きな美食家は美味しい甘味処を優先して観光の計画を立てることが多い．
  \item[\textbf{観察3}] ユーザの行動は趣味嗜好に依存する．ここでいう行動は，それぞれの訪問場所における，ユーザが行った具体的な動作・アクションを表す．例えば写真撮影をしたり，甘味を食べたり，座禅を組むことは観光地におけるよくある行動である．趣味嗜好が似ているユーザは同じ行動を行う確率は高い．また，同じ場所においてユーザが複数の行動を行うこともよくある．
  \item[\textbf{観察4}] 行動をする時間は趣味嗜好に影響される．例えばお酒を飲むことが好きな人たちは夜に当地の居酒屋で飲むのを好んだりする一方で，朝早くに観光を楽しむ人もいる．
  \item[\textbf{観察5}] それぞれの場所でする行動はその場所に影響される．その場所でよくある行動であれば，ユーザもその行動を取る可能性が高い．有名スポットで写真をとることはその一つの例である．
\end{description}
%
\subsection{ユーザ体験の分析手法} \label{model_definition}
\ref{intuition}節で説明した観察を踏まえて，ユーザ体験を分析する．
分析手法の候補として3つのモデルを構成した．
観察１，観察２，観察３のみを取り入れてユーザ体験の基本(Who, Where, What)と分析するベースモデル，観察5を取り入れて場所の特徴(空間的制約)を考慮した場所対応(Loacation-Aware)モデル，観察4を取り入れて時間の特徴(時間的制約)を考慮した時間対応(Time-Aware)モデルの３つである．
説明するに当たって必要な記号を表\ref{variable_definition}に示す．

\begin{center}
  \begin{table}[tb]
  \caption{記号の定義}
  \label{variable_definition}
  \begin{tabular}{ p{1.5cm} p{6cm} }
    \hline
    記号 & 定義 \\
    \hline
    \bm{$G$} & グループの集合 \\
    \bm{$U$} & ユーザの集合 \\
    \bm{$D$} & 投稿の集合 \\
    \bm{$L$} & 場所の集合 \\
    \bm{$W$} & 行動を示す単語の集合 \\
    \bm{$T$} & 時間の集合 \\
    \hline
    $|\bm{D}|$ & 投稿(データ)数 \\
    $|\bm{G}|$ & グループ数 \\
    $|\bm{U}|$ & ユーザ数 \\
    $|\bm{L}|$ & 場所数 \\
    $|\bm{W}|$ & 行動を示す単語数 \\
    $N_w$ & ある投稿$d(\in D)$での行動を示す単語数 \\
    \hline
    $g_d$ & ある投稿$d(\in D)$におけるグループ \\
    $u_d$ & ある投稿$d(\in D)$におけるユーザ \\
    $l_d$ & ある投稿$d(\in D)$における位置情報 \\
    $w_d$ & ある投稿$d(\in D)$における行動を示す単語 \\
    $t_d$ & ある投稿$d(\in D)$における時間 \\
    \hline
    $\theta$ & グループを与えるカテゴリ分布 \\
    $\pi_{g_d}$ & グループごとのユーザの生成確率分布 \\
    $\phi_{g_d}$ & グループごとの位置情報の生成確率分布 \\
    $\sigma_{g_d}$ & グループごとの行動を示す単語の生成確率分布 \\
    $\mu_{l_d}$ & グループごとの行動を示す単語の生成確率分布 \\
    $\tau_{g_d}$ & グループごとの時間の生成確率分布 \\
    \hline
    $\alpha, \beta, \gamma$, $\delta$, $\epsilon$ & ハイパーパラメータ \\
    \hline
  \end{tabular}
  \end{table}
\end{center}
%

グループは離散データであり，カテゴリカル分布によって生成される．
つまり以下の式が成り立つ．
\begin{equation}
  g_d \sim Categorical(\theta)
\end{equation}
ベイズ確率モデルを構築するとき，カテゴリカル分布の事前分布は共役事前分布であるディリクレ分布を用いる．
それゆえ，$g_d$の事前分布である$\theta$は次の式で生成される．
\begin{equation}
  \theta \sim Dir(\alpha)
\end{equation}

ユーザ，場所，時間についても離散データであるため，カテゴリカル分布から生成される．
それぞれ$\pi_{g_d}, \phi_{g_d}, \tau_{g_d}$から生成され，その事前分布にディリクレ分布を持つ．
式で表すと
\begin{eqnarray}
  \pi_{g_d} &\sim& Dir(\gamma) \nonumber \\ 
  \label{prior-distribution-generate}
  \phi_{g_d} &\sim & Dir(\beta) \\
  \tau_{g_d} &\sim& Dir(\epsilon) \nonumber
\end{eqnarray}
となる．

\subsubsection{ベースモデル} \label{base-model}
本研究のモデルでは，ユーザ，場所，行動を表す単語を観測変数として扱い，主にグループを潜在変数とする．
つまりユーザの趣味嗜好の部分はこのグループによって抽出される．
ベースモデルのグラフィカルモデルを図\ref{basemodel}に示す．
ただし，グラフィカルモデル上の$w_{d, i}$というのはある投稿$d(\in D)$における行動を示す単語のうち$i$番目の単語という意味である．
%
\begin{center}
\begin{figure}[tb]
  \tikz{
    \node[latent] (group) {$g_d$};
    \node[obs, above=of group] (user) {$u_d$};
    \node[obs, right=of group, xshift=1cm] (word) {$w_{d,i}$};
    \node[latent, left=of group] (theta) {$\theta$};
    \node[const, above=of theta] (alpha) {$\alpha$};
    \node[obs, above=of word] (location) {$l_d$};
    \node[latent, above=of location, yshift=.5cm] (phi) {$\phi_{g_d}$};
    \node[const, above=of phi] (beta) {$\beta$};
    \node[latent, above=of user, yshift=.5cm] (pi) {$\pi_{g_d}$};
    \node[const, above=of pi, inner sep=.05cm] (gamma) {$\gamma$};
    \node[latent, right=of word] (sigma) {$\sigma_{g_d}$};
    \node[const, above=of sigma] (delta) {$\delta$};

    \edge {alpha} {theta};
    \edge {theta} {group};
    \edge {group, pi} {user};
    \edge {group, sigma} {word};
    \edge {delta} {sigma};
    \edge {phi, group} {location};
    \edge {beta} {phi};
    \edge {gamma} {pi};

    \plate[inner sep=.25cm, xshift=-.15cm, yshift=.15cm] {word-plate} {(word)} {$N_w$};
    \plate[inner sep=.25cm, xshift=-.15cm, yshift=.15cm] {data-plate} {(word-plate)(location)(user)(group)} {$|\bm{D}|$};
    \plate[inner sep=.30cm, yshift=.15cm] {group-plate1} {(phi)(pi)} {$|\bm{G}|$};
    \plate[inner sep=.25cm, yshift=.15cm] {group-plate2} {(sigma)} {$|\bm{G}|$};
  }
  \caption{ベースモデルのグラフィカルモデル}
  \label{basemodel}
\end{figure}
\end{center}
%
ベースモデルでは観察1, 観察2, 観察3を元にモデリングしている．観察1は$g_d$から$u_d$への矢印に対応しており，観察2は$g_d$から$l_d$への矢印，観察3は$g_d$から$w_{d,i}$への矢印で表現している．
ベースモデルは観測データ間の影響がないもっともシンプルな状態のモデルである．
%
\begin{algorithm}[tb]
  \caption{ベースモデルにおける生成過程}\label{generative_part}
  \begin{algorithmic}[1]
    \State $\theta \sim Dir(\alpha)$ \Comment{グループ事前分布を生成}
    \For{$g$ in $|\bm{G}|$}
    \State $\pi_g \sim Dir(\gamma)$ \Comment{ユーザ事前分布を生成}
    \State $\phi_g \sim Dir(\beta)$ \Comment{場所事前分布を生成}
    \State $\sigma_g \sim Dir(\delta)$ \Comment{単語事前分布を生成}
    \EndFor
    \For{$d$ in $|\bm{D}|$} \Comment{グループごとに処理}
    \State $g_d \sim Categorical(\theta)$ \Comment{グループを生成}
    \State $u_d \sim Categorical(\pi_{g_d})$ \Comment{ユーザを生成}
    \State $l_d \sim Categorical(\phi_{g_d})$ \Comment{場所を生成}
    \For{$d$ in $N_w$}
    \State $w_{d, i} \sim Categorical(\sigma_{g_d})$ \Comment{行動を示す単語を生成}
    \EndFor
    \EndFor
  \end{algorithmic}
\end{algorithm}

ベースモデルにおける生成過程を説明していく．アルゴリズムをAlgorithm\ref{generative_part}に示す．
まずはじめにグループの事前分布である$\theta$が生成される．
その後，式\ref{prior-distribution-generate}と同様にグループごとにユーザ，場所，行動を示す単語の事前分布を生成する．

ここからはある投稿データ$d(\in \bm{D})$の元で生成していく．
グループの生成確率分布$\theta$からグループ$g_d$を生成し，
\begin{equation}
  g_d \sim Categorical(\theta)
\end{equation}
と表せる．
ここでのグループは潜在変数であり，ユーザの趣味嗜好が含まれることになる．
投稿データのプレート上にあるのはその投稿データのユーザ，場所，行動であり，そのグループが決まることで趣味嗜好が決まり，それを元にユーザ，場所，行動が決まると言える．

観察1より，ユーザの趣味嗜好を表すグループにユーザは属する．それゆえ，以下の関係が成り立つ．
\begin{equation}
  u_d \sim Categorical(\pi_{g_d})
\end{equation}
同様に場所も観察2よりグループごとの位置情報の生成確率分布$\phi_{g_d}$から生成され，
\begin{eqnarray*}
  l_d & \sim & Categorical(\phi_{g_d}) \\
  \phi_{g_d} & \sim & Dir(\beta)
\end{eqnarray*}
が成り立つ．
最後に行動を示す単語は$w_{d, i}$で表しているが，この変数が単独でプレートに載っていることから，ユーザや場所が決まる投稿に対して，行動は複数($N_w$個)存在することを示している(観察3)．

\subsubsection{場所対応モデル} \label{location-aware-model}
場所対応モデルはベースモデルに対して観察5を導入したものである．
場所対応モデルのグラフィカルモデルを図\ref{lw_model}に示す．

\begin{center}
\begin{figure}[tb]
  \tikz{
    \node[latent] (mu) {$\mu_{l_d}$};
    \node[obs, above=of mu, yshift=.7cm] (word) {$w_{d,i}$};
    \node[latent, left=of mu, xshift=-.5cm] (lambda) {$\lambda_{l_d}$};
    \node[latent, left=of word, xshift=-.5cm] (group) {$g_d$};
    \node[obs, above=of group] (user) {$u_d$};
    \node[latent, left=of group] (theta) {$\theta$};
    \node[const, above=of theta] (alpha) {$\alpha$};
    \node[obs, above=of word] (location) {$l_d$};
    \node[latent, above=of location, yshift=.5cm] (phi) {$\phi_{g_d}$};
    \node[const, above=of phi] (beta) {$\beta$};
    \node[latent, above=of user, yshift=.5cm] (pi) {$\pi_{g_d}$};
    \node[const, above=of pi, inner sep=.05cm] (gamma) {$\gamma$};
    \node[latent, right=of word] (sigma) {$\sigma_{g_d}$};
    \node[const, above=of sigma] (delta) {$\delta$};
    \node[const, right=of mu] (epsilon) {$\epsilon$};

    \edge {alpha} {theta};
    \edge {theta} {group};
    \edge {group, pi} {user};
    \edge {group, location, sigma, mu, lambda} {word};
    \edge {delta} {sigma};
    \edge {phi, group} {location};
    \edge {beta} {phi};
    \edge {gamma} {pi};
    \edge {epsilon} {mu};

    \plate[inner sep=.25cm, inner xsep=.5cm, xshift=-.15cm, yshift=.15cm] {word-plate} {(word)} {$N_w$};
    \plate[inner sep=.25cm, xshift=-.15cm, yshift=.15cm] {data-plate} {(word-plate)(location)(user)(group)} {$|\bm{D}|$};
    \plate[inner sep=.30cm, yshift=.15cm] {group-plate1} {(phi)(pi)} {$|\bm{G}|$};
    \plate[inner sep=.25cm, yshift=.15cm] {group-plate2} {(sigma)} {$|\bm{G}|$};
    \plate[inner sep=.25cm, yshift=.15cm] {location-plate} {(lambda)(mu)} {$|\bm{L}|$};
  }
  \caption{場所対応モデルのグラフィカルモデル}
  \label{lw_model}
\end{figure}
\end{center}

生成過程はベースモデルより行動を生成する部分が複雑になる．
観察5はその場所の特徴もその場で行う行動の意思決定に影響することを表している．
そのため，場所対応モデルではその行動がどれほどその人の趣味嗜好に受けたか，もしくはどれほどその場所に影響を受けたかを表す潜在変数$\lambda_{l_d}$を導入している．
アルゴリズムをアルゴリズム\ref{location-aware-generative-part}

\begin{algorithm}[tb]
  \caption{場所対応モデルにおける生成過程}\label{location-aware-generative-part}
  \begin{algorithmic}[1]
    \State $\theta \sim Dir(\alpha)$ \Comment{グループ事前分布を生成}
    \For{$g$ in $|\bm{G}|$}
    \State $\pi_g \sim Dir(\gamma)$ \Comment{ユーザ事前分布を生成}
    \State $\phi_g \sim Dir(\beta)$ \Comment{場所事前分布を生成}
    \State $\sigma_g \sim Dir(\delta)$ \Comment{単語事前分布を生成}
    \EndFor
    \For{$l$ in $|\bm{L}|$} \Comment{場所ごとに処理}
    \State $\mu_l \sim Bernoulli(\epsilon)$
    \EndFor
    \For{$d$ in $|\bm{D}|$} \Comment{グループごとに処理}
    \State $g_d \sim Categorical(\theta)$ \Comment{グループを生成}
    \State $u_d \sim Categorical(\pi_{g_d})$ \Comment{ユーザを生成}
    \State $l_d \sim Categorical(\phi_{g_d})$ \Comment{場所を生成}
    \For{$d$ in $N_w$}
    \State $w_{d, i} \sim Categorical(\sigma_{g_d}) + (1-\lambda_{l_d}) Categorical(\sigma_{g_d})$ \Comment{行動を示す単語を生成}
    \EndFor
    \EndFor
  \end{algorithmic}
\end{algorithm}
%
変数$\lambda_{l_d}$は場所ごとに生成される．行動の場所への依存関係つまりその場所がある行動をすることを目的として来るべき場所なのか，それともその場所にきて色々な行動をするのかをモデリングする．例えば，居酒屋に行けばほとんどの人がご飯を食べるという行動をするだろうし，公園などはそれぞれ過ごし方は好みによって異なる．

この変数$\lambda_{l_d}$を用いて$w_{d, i}$は生成される．具体的には$g_d, l_d$が生成された後，場所ごとに生成された変数$\lambda_{l_d}$を重みとして扱って行動を示す単語を生成する．式で書くと以下のようになる．
\begin{eqnarray}
  \lambda_{l_d} &\sim& Bernoulli(\eta) \\
  w_{d,i} &\sim& \lambda_{l_d} Categorical(\mu_{l_d})  \nonumber \\
  &&+ (1-\lambda_{l_d}) Categorical(\sigma_{g_d})
\end{eqnarray}
ただし，$\eta$はハイパーパラメータである．

\subsubsection{時間対応モデル} \label{time-aware-model}
時間対応モデルはベースモデルに時間の影響を考慮したモデルである．
このグラフィカルモデルを図\ref{time_model}に示す．
%
\begin{center}
\begin{figure}[tb]
  \tikz{
    \node[obs] (time) {$t_d$};
    \node[obs, above=of time, yshift=.5cm] (word) {$w_{d,i}$};
    \node[latent, left=of word, xshift=-1cm] (group) {$g_d$};
    \node[obs, above=of group] (user) {$u_d$};
    \node[latent, left=of group] (theta) {$\theta$};
    \node[const, above=of theta] (alpha) {$\alpha$};
    \node[obs, above=of word] (location) {$l_d$};
    \node[latent, above=of location, yshift=.5cm] (phi) {$\phi_{g_d}$};
    \node[const, above=of phi] (beta) {$\beta$};
    \node[latent, above=of user, yshift=.5cm] (pi) {$\pi_{g_d}$};
    \node[const, above=of pi, inner sep=.05cm] (gamma) {$\gamma$};
    \node[latent, right=of word] (sigma) {$\sigma_{g_d}$};
    \node[const, above=of sigma] (delta) {$\delta$};
    \node[latent, right=of time] (tau) {$\tau_{g_d}$};
    \node[const, right=of tau] (kappa) {$\kappa$};

    \edge {alpha} {theta};
    \edge {theta} {group};
    \edge {group, pi} {user};
    \edge {group, tau} {time};
    \edge {group, sigma} {word};
    \edge {delta} {sigma};
    \edge {phi, group} {location};
    \edge {beta} {phi};
    \edge {gamma} {pi};
    \edge {kappa} {tau}

    \plate[inner sep=.25cm, xshift=-.15cm, yshift=.15cm] {word-plate} {(word)} {$N_w$};
    \plate[inner sep=.25cm, xshift=-.15cm, yshift=.15cm] {data-plate} {(word-plate)(location)(user)(group)(time)} {$|\bm{D}|$};
    \plate[inner sep=.30cm, yshift=.15cm] {group-plate1} {(phi)(pi)} {$|\bm{G}|$};
    \plate[inner sep=.25cm, yshift=.15cm] {group-plate2} {(sigma)(tau)} {$|\bm{G}|$};
  }
  \caption{時間対応モデルのグラフィカルモデル}
  \label{time_model}
\end{figure}
\end{center}
%
\begin{algorithm}[tb]
  \caption{時間対応モデルにおける生成過程}\label{time-aware-generative-part}
  \begin{algorithmic}[1]
    \State $\theta \sim Dir(\alpha)$ \Comment{グループ事前分布を生成}
    \For{$g$ in $|\bm{G}|$}
    \State $\pi_g \sim Dir(\gamma)$ \Comment{ユーザ事前分布を生成}
    \State $\phi_g \sim Dir(\beta)$ \Comment{場所事前分布を生成}
    \State $\sigma_g \sim Dir(\delta)$ \Comment{単語事前分布を生成}
    \State $\tau_{g_d}  \sim  Dir(\kappa)$ \Comment{時間事前分布を生成}
    \EndFor
    \For{$d$ in $|\bm{D}|$} \Comment{グループごとに処理}
    \State $g_d \sim Categorical(\theta)$ \Comment{グループを生成}
    \State $u_d \sim Categorical(\pi_{g_d})$ \Comment{ユーザを生成}
    \State $l_d \sim Categorical(\phi_{g_d})$ \Comment{場所を生成}
    \State $t_d  \sim  Categorical(\tau_{g_d})$ \Comment{時間を生成}
    \For{$d$ in $N_w$}
    \State $w_{d, i} \sim Categorical(\sigma_{g_d})$ \Comment{行動を示す単語を生成}
    \EndFor
    \EndFor
  \end{algorithmic}
\end{algorithm}
%
時間対応モデルでは観測変数間の影響はベースモデルと同様にない．それゆえ，生成過程はベースモデルの生成過程に時間に関係する要素を加えれば問題ない．
生成過程をアルゴリズム\ref{time-aware-generative-part}に示す．

あるデータ$d(\in D)$が生成された時間はそのデータが示す観光に関する趣味嗜好$g_d$に影響されて決定される．時間は離散的に考え，カテゴリカル分布から生成されたこととする．この時，$t_d$を生成する過程を式で表すと，
\begin{eqnarray}
  t_d & \sim & Categorical(\tau_{g_d}) \\
  \tau_{g_d} & \sim & Dir(\kappa)
\end{eqnarray}
となる．

\subsection{ユーザ体験の推薦手法} \label{recommendation}
本節では，ユーザ体験の推薦手法について説明する．節\ref{model_definition}で構築したユーザ体験の分析モデルを用いて推論を行い，新しいユーザに対してユーザ体験を推薦する．

推薦をするに当たってユーザに対してより良いユーザ体験を提供するためにはユーザの情報が不可欠である．
それゆえ今回は推薦をする前にユーザの情報を取得する必要があり，本研究では初期にアンケートを行う．
初期アンケートをしてそのユーザがどのような観光体験を好むのか，どのような体験には興味を示さないのかを測ることができる．

初期アンケートについての詳細はアプリケーションのユーザインターフェースの話になるので節\ref{application}で述べるが，初期アンケートを実行することで新しいユーザ$u'$に対してアンケートで示した写真の場所およびタグに対する好みを取得できる．
アンケートに表示する写真の一つを$d_0$とする.
この時ユーザは$d_0$を見てその場所と写真が表すその場所での行動を認識し点数をつける．
これは$d_0$の場所$l_0$と複数のタグ$\bm{w_0}(=w_{0,0}, \dots, w_{0,N_{w_0}})$に対するユーザ$u'$の評価と考えられ，$p(l_0,\bm{w_0}|u')$とする．

ベイズの公式により以下の式で$p(u'|l_0, \bm{w_0})$を得る．
\begin{eqnarray}
  \label{bayes-eq}
  p(u'|l_0, \bm{w_0}) = \frac{p(l_0, \bm{w_0}|u')p(u')}{p(l_0, \bm{w_0})}
\end{eqnarray}
初期アンケートには複数の写真を表示する．
それら$n$枚あるとして各写真を$d_0 \dots d_n$とし，上の式(\ref{bayes-eq})を更新していく．
更新するにあたって，式(\ref{bayes-eq})の事前分布に当たる$p(u')$はそれまでの写真で得た事後分布を使う．
これらを式に表すと，
\begin{align}
  &p(u'|l_0, \bm{w_0}, \dots , l_n, \bm{w_n}) = \frac{p(l_n, \bm{w_n}|u')}{p(l_n, \bm{w_n})} \nonumber \\
  &* p(u'|l_0, \bm{w_0}, \dots , l_{n_1}, \bm{w_{n-1}}) \\
  \label{bayes-update}
  =& \dfrac{\prod_i^n p(l_i, \bm{w_i}|u')}{\prod_i^n p(l_i, \bm{w_i})} p(u') 
\end{align}
となる．

推薦システムで最終的に知りたいことはユーザが好みそうな観光場所とその場での行動を提供することである．
ここで$p(L,W|u')$を求めることができればその確率をスコアとしてランキングを作成することができ，よりユーザが好みそうな観光場所とその場での行動を提供することができる．
ベイズの公式を適用すると，
\begin{eqnarray}
  p(L,W|u') = \frac{p(u'|L, W) p(L,W)}{p(u')}
\end{eqnarray}
となる．
ここで先の式(\ref{bayes-update})を$p(u'|L,W)$とみなすことで，$p(L,W|u')$を得る．
これを式で表すと，
\begin{eqnarray}
  p(L,W|u') &=& \dfrac{\dfrac{\prod_i^n p(l_i, \bm{w_i}|u')}{\prod_i^n p(l_i, \bm{w_i})} p(u')
 p(L,W)}{p(u')} \\
  \label{recommendation-score}
  &=& \dfrac{\prod_i^n p(l_i, \bm{w_i}|u')}{\prod_i^n p(l_i, \bm{w_i})} p(L,W)
\end{eqnarray}
となる．

上の式(\ref{recommendation-score})の$p(l_i, \bm{w_i})$は分析手法で学習した事後分布を用いることで計算することができる．
分析手法ではデータごとにグループを生成し，そのグループを元に場所や行動を示す単語を生成している．
それゆえ，場所や行動を示す単語の生成確率を計算するためには以下のようにグループを周辺化する必要がある．
ある投稿データの場所を$l$とそのデータの行動を示す複数の単語を$\bm{w}(=w_0, \dots, w_{N_w})$とすると,
\begin{align}
  p(l, \bm{w}) &= \sum_g^G p(l, \bm{w}|g) \\
  &= \sum_g^G \sum_i^{N_w} p(l, w_i|g)
\end{align}

ここで$p(l,w_i|g)$の計算は分析手法のモデルによる．
ベースモデルや時間対応モデルは場所と行動を示す単語間に影響はないため，
\begin{align}
  p(l, w_i|g) &= p(l|g) p(w_i|g)  \nonumber \\
  &= \phi(l|g) \sigma(w_i|g)
\end{align}
と表せる．

一方場所対応モデルでは行動を示す単語の生成に場所の影響が入るため，
\begin{align}
  p(l, w_i|g) &= p(w_i|g, l) p(l|g) \nonumber \\
  &= \{ \lambda_l p(w_i|l) + (1-\lambda_l) p(w_i|g) \} p(l|g) \\
  &= \{ \lambda_l \mu(w_i|l) + (1-\lambda_l) \sigma(w_i|g) \} \phi(l|g) \nonumber
\end{align}
と計算できる．

%---------------------------------------------------
\section{実験} \label{experiment}
この節では分析手法の評価実験の計画について述べる．
最初にデータセットについて述べ，その後実験計画について述べていく．

\subsection{データセット} \label{dataset}
節\ref{def}で議論したようにInstagramやFlickrの情報は投稿自体にWho, When, Where, Whatの4つの情報が含まれている．
故に体験を分析するにはこのようなデータが適しており，実験ではYahoo Flickr Creative Commons 100M(以下YFCC)\cite{thomee2016yfcc100m}を使って行った．
YFCCは過去のFlickrのデータが大量に存在し，世界中の写真とそのメタ情報が提供されている．
今回はそのデータを京都市内のデータに限定し，提案モデルの観測データとして扱う．
実際のデータ数は以下の表\ref{dataset-table}に示す．

\begin{table}[tb]
  \begin{center}
    \caption{データの概要}
    \label{dataset-table}
    \begin{tabular}{ p{5cm} p{1.5cm} } \hline \hline
      データの種類 & データ数 \\  \hline
      ユーザ & 915 \\
      場所 & 1065 \\
      タグの種類 & 2659 \\
      総タグ数 & 372599 \\ \hline
      データ数 & 37469 \\ \hline \hline
    \end{tabular}
  \end{center}
\end{table}

YFCCで得られるメタ情報の中で場所の情報は緯度・経度とその場所の住所がある．
その中で緯度・経度を使い，クラスタリングを行いスポット(場所$l$)を求める．
緯度・経度をそのまま使用すると同じ場所として認識されることがほぼなくなってしまい，全て異なる場所となってしまう．
本研究におけるユーザ体験の要素である場所の意味するところは観光地としての役割である．
それゆえ，先行研究\cite{sun2020dexa}で用いられたクラスタリングを行い，観光地内は同じスポットとして扱う．
表\ref{dataset-table}で示されてる場所の数はクラスタの数である．
クラスタリングした時にクラスの代表点が定まるのでそれを地図にマッピングすると図\ref{mapping_image}となる．
マッピングにはGoogle My Mapを用いた．

\begin{figure}[tb]
  \begin{center}
    \includegraphics[clip, width=6cm] {./image/mapping.eps}
    \caption{クラスタリング後の場所の配置}
    \label{mapping_image}
  \end{center}
\end{figure}

また，タグに関してYFCCでは写真ごとにタグ付がなされている．
一つの写真について以下の３種類のタグ付がなされている．
\begin{description}
  \setlength{\leftskip}{.5cm}
  \item[\textbf{ユーザがつけるタグ}] ユーザが投稿の際につけるタグである．ユーザがつけるタグに制限はなく，自由にタグを付け加えることができる．
  \item[\textbf{機器がつけるタグ}] カメラやコンピュータ，その他自動システムによって自動的につけられたタグである．
  \item[\textbf{画像認識によってつけるタグ}] これはBartらが畳み込みニューラルネットワークを用いて画像認識をし，タグ付したものである．メタ情報自体は単数または複数のタグとそれぞれについて検出確率がついている．
\end{description}
実験に用いるデータセットでは以上の3つのタグが全て存在しないデータは省いた．

また，今回の実験ではこれらのYFCCに元からついていたタグだけでなく新たにその写真の状況を判断する場面検出(シーンディテクション)を行い，新しいタグを作ることにした．
場面検出ではPlace365\cite{zhou2017places}を用いて各写真ごとにindoorかoutdoorの確率とそれぞれのシーンの確率を割り出した．
ここでいうシーンとはバーやビーチなどの場所を365カテゴリに分けて検出することができる．

今回の実験では主にYFCCにもとからついていた画像認識によってつけるタグとPlace365による場面検出によるタグの２種類を用いる．

\subsection{実験計画} \label{experimental-setting}
今回の実験では上記のデータセットを用いてユーザ体験の分析を行う．
節\ref{model_definition}で述べた各モデルに対して上記のデータセットを用いて学習する．
今回の推論の学習は変分推論を用いた．
最適化手法はAdam\cite{kingma2014adam}を用いて行い，その学習rateは$0.001$とした．
ハイパーパラメータである$\alpha, \beta, \gamma, \delta, \epsilon$はそれぞれ一様分布を用い，初期値は$1/(要素の長さ)$とする．
以上5つのパラメータの他に与えるデータとしてはグループの数が存在する．
グループはユーザのトピックを表すのでその数は評価に大きく影響してくる．
今回の実験ではグループ数はハイパーパラメータとして最小3として複数のグループ数で試すこととする．

データセットはランダムに1割をテストデータとして分割し，訓練データで学習して評価にはテストデータを用いる．
また，実装にはPyroを用いて行う．

\subsection{評価} \label{evaluation}
今回の実験の評価は各モデルに対してどれほど人々の趣味嗜好を抽出できているかということであることとその精度である．それぞれをどのように測定するのかをこの節では説明していく．

\subsubsection{Coherence} \label{coherence}
節\ref{proposed_method}ではグループを導入することで人々の趣味嗜好をグループ単位でまとめることができると述べている．
このタスクはクラスタリングとは違うが，グループにまとめるという点で同じような性質を持つと考えられる．
また，ある人があるグループに属する確率が出るのであって，たくさんのグループに属する可能性があることからソフトクラスタリングに似ている．
つまり評価指標としてはソフトクラスタリングでいう内部結合性をもつかどうかを判断すべきである．
このことは今回のタスクに対応して述べると，そのグループに所属する人は同じような趣味嗜好をもっているべきであるという観察1の内容と一致する．

また，トピックモデルの指標としてCoherence\cite{first-coherence}というものがある．
Coherenceはそのトピック内の要素の類似度が高いほど評価値が高くなる．
それゆえ今回は観察1の内容を測る指標としてCoherenceを採用することにした．

Coherenceにもいくつか種類があるが，それは最終的に求める要素間の関係をどのように表すかという議論に帰着する．
例えばトピックモデルの中でよく使われるモデルのLDA\cite{blei2003latent}ではUCI\cite{newman2010automatic}と呼ばれるCoherenceの1種が使われる．
このUCIではWekipediaを用いて単語間の距離を計算しており，文章における単語間の距離を外部コーパスに頼っている．
しかし，今回はタグを扱っており文章中の単語とは異なるため，タグ間の関係はデータから考えることとする．
このようにデータから直接単語間の距離を求めるものにUMass\cite{mimno2011optimizing}というCoherenceの種類が存在する．

ゆえに今回はUMassを用いてCoherenceを計算する．
具体的な求め方は以下のようになる．
\begin{equation*}
  Coherence = \sum_g^G \sum_{i=1}^c \sum_{j=1}^{i-1} log \frac{D(w_i, w_j) + \epsilon}{D(w_j)}
\end{equation*}
ただし，$D(w_i)$は$w_i$と$w_j$が同時に出現する写真数，$D(w_j)$は$w_j$が出現する写真数である．
また，$c, \epsilon$はパラメータであり，元の論文\cite{mimno2011optimizing}に従いそれぞれ$10, 1$とする

\subsubsection{精度} \label{precision}
精度は学習を進めるに当たってその正確さを求めるものである．
今回の実験でいうと，よりデータが表すユーザの行動をモデルが学習できているかというものである．
今回の実験では精度の指標として以下の2つをあげる．

\begin{quote}
  \begin{itemize}
      \item ELBO
      \item Perplexity
  \end{itemize}
\end{quote}

ELBOに関しては学習の過程でどれほど学習が進んでいるかを判断する大事な指標である．ELBOはその値を最大化することで今推論している近似分布と真の事後分布との距離を縮めることができます．学習の目的はこの事後分布との距離を最小にすることであるので，精度としての指標としてまず最初に考えることができる．

次にPerplexityであるが，これはCoherenceと同様にトピックモデルでよく使われる指標である．
Perplexityは確率モデルにおける予測精度を示すもので次のように定義される．
\begin{equation*}
  Perplexity = exp \{ - \frac{1}{N} \sum_n^N log p(x_n) \}
\end{equation*}
ただし，$N$はデータ数を表し，$p(x_n)$はそのデータにおける尤度を示している．


%---------------------------------------------------
\section{アプリケーション} \label{application}
本研究ではユーザ体験分析モデルを利用した推薦アプリケーションを設計した．
このアプリケーションでは実際にユーザに観光地を選んでもらい，趣味嗜好を考慮しながら観光体験の推薦を行う．
主な機能としては観光体験の推薦の他に，趣味嗜好を知るためのアンケートおよびグループの推論である．

全体のアーキテクチャ図を図\ref{architecture}に示す．
以下，ユーザインターフェースと実際の機能の詳細について説明する．

\begin{figure}[tb]
  \begin{center}
    \includegraphics[clip, width=8cm] {./image/architecture.eps}
    \caption{全体の構成図}
    \label{architecture}
  \end{center}
\end{figure}


\subsection{ユーザインターフェース}
開発アプリケーションは2つの画面からなる(図\ref{questionaire_image}, 図\ref{recommendation_image})．
\begin{figure}[tb]
  \begin{center}
    \includegraphics[clip, width=8cm] {./image/questionaire.eps}
    \caption{初期アンケート画面}
    \label{questionaire_image}
  \end{center}
\end{figure}

\begin{figure}[tb]
  \begin{center}
    \includegraphics[clip, width=8cm] {./image/recommendation.eps}
    \caption{推薦画面}
    \label{recommendation_image}
  \end{center}
\end{figure}
図\ref{questionaire_image}は初期アンケートを行う画面で，ユーザがアプリケーションを訪れた時に最初に表示する．
初期アンケート画面ではユーザはいくつかの画像を見て，興味の度合いをそれぞのの画像に対してフィードバックする．
その結果をもとにユーザの属する情報を判断する．

図\ref{recommendation_image}は推薦を行う画面であり，ここでユーザは観光体験の推薦を行う．
推薦画面では，左側に推薦された観光体験がリストで表示されており，ユーザはクリックしたり，再推薦を行うことができる．
また，観光場所のデータが地図上に全てマッピングされており，ユーザは選ぶことができる．

初期アンケート画面は最初のみでそれ以降は主に推薦画面での操作となる．

\subsection{アプリケーションの機能} \label{function_design}
アプリケーションの機能としては主に観光体験の推薦とグループの推論に分かれる．
そしてこの主な2つの機能は2つのエンジンに分けて実現している．
観光体験を推薦する機能を担う方をベースエンジン，グループの推論をする機能を担う方を推論エンジンとする．
ベースエンジンは\ref{model_definition}節のモデルを構築，実現する．
推論エンジンは\ref{online_estimation}節の逐次推論手法を実装する．
以降それぞれのエンジンにわけて説明していく．

\subsubsection{ベースエンジン}
ベースエンジンでは，主に提案手法で説明したモデルを用いて観光体験の推薦を行う．
入力自体はユーザのIDのみを受け付ける．
そのユーザの属するグループは推論エンジンによって推論されるので，データベースを読み出すことによってユーザの属するグループを把握することができる．
故にグループがわかったので，モデルに当てはめることでそのグループのトピックの分布，および場所，行動を示す単語の生成確率分布を取得できる．
あとは確率的に高い順にスコアリングし，推薦に出力することができる．
出力自体は位置情報，行動を示す単語のリストとなる．

\subsubsection{推論エンジン}
推論エンジンではアプリケーションに訪れたユーザがどのグループに属するかを推論する役割をもつ．
ここでいうグループとは，すでに提案手法で示したモデルの学習があらかじめ終了しており，学習データのユーザがクラスタリングされたものである．
推論エンジンが推論をするタイミングは複数存在する．

まず初めに初期アンケートの時に推論を行う．
初期アンケートはコールドスタート問題に対応するもので，いくつかの画像を見せてユーザにそれぞれの画像に対してフィードバックをしてもらう．
実際に見せる画像はグループごとの代表的な画像となっており，そのフィードバックをベクトルとして入力する．
推論はグループごとのアンケート画像の生成確率のベクトルと類似度をはかり，スコアの高いものとする．

次に，推薦画面でユーザが観光体験をクリックしたときである．
クリックしたということはユーザがその体験に興味を示したことを表す．
この時にユーザの属するグループのその体験に対する生成確率と他のグループの確率を比べる．

最後に推薦自体のフィードバックした時に推論を行う．
推薦した体験一つ一つにフィードバックをしてもらい，そのベクトルを入力とする．
推論の仕方自体は初期アンケートと同じである．

以上3つのタイミングで推論を行い，随時ユーザの好みに合わせて属するグループを更新していく．


%---------------------------------------------------
\section{今後の課題} \label{future_work}
本節では推薦システムを実現するために今後必要なことを示す．

\begin{quote}
  \begin{itemize}
    \item 推薦アルゴリズムの実装
    \item 他手法との比較実験による推薦システムの有効性の証明
    \item アプリケーションにおけるユーザの趣味嗜好の逐次更新のアルゴリズム決定
    \item アプリケーションの実装
  \end{itemize}
\end{quote}

%---------------------------------------------------
\section{まとめ} \label{summary}
本研究では個人化した観光に対する推薦を実現するために，観光の体験を分析し趣味嗜好を推論するシステムを提案した．
体験の分析ではWho, Where, When, Whatの4要素に着目し，5つの観察を考慮することでモデリングを行った．
また，潜在変数をモデルに加えることでコールドスタート問題に対応した．
アプリケーションでは，提案手法のモデルを応用して推薦システムにした他，ユーザのフィードバックを適宜得ることによってより正確な推論をができるような構成を提案した．

\bibliographystyle{abbrv}
\bibliography{paper}

\end{document}
